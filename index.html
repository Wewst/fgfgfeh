<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>Барахолка Березники</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
/* Твой оригинальный CSS без изменений */
:root{
  --brand:#2F6F6A;
  --bg: linear-gradient(180deg, #f0f2f5, #e2e6ea);
  --text:#111;
  --glass:rgba(255,255,255,.65);
  --card:rgba(255,255,255,.75);
  --steamA:rgba(240,245,255,0.28);
  --steamB:rgba(230,235,245,0.16);
}
body.dark{
  --bg:linear-gradient(180deg,#0d1012,#171b1f);
  --text:#f2f4f5;
  --glass:rgba(30,35,40,.6);
  --card:rgba(30,35,40,.75);
  --steamA:rgba(120,160,170,.18);
  --steamB:rgba(120,160,170,.08);
}
*{margin:0;padding:0;box-sizing:border-box}
body{
  font-family:-apple-system,BlinkMacSystemFont,"SF Pro Display",sans-serif;
  background:var(--bg);
  color:var(--text);
  overflow-x:hidden;
  transition:background .6s,color .4s;
  min-width:360px;
  min-height:100vh;
  padding-top:80px;
}
.steam{position:fixed;inset:0;pointer-events:none;z-index:0}
.steam::before,.steam::after{
  content:"";position:absolute;inset:-25%;
  background:radial-gradient(circle at 30% 70%,var(--steamA),transparent 65%),radial-gradient(circle at 70% 40%,var(--steamB),transparent 70%);
  filter:blur(70px);
  animation:steamMove 35s linear infinite;
}
.steam::before{opacity:0.45;}
.steam::after{animation-duration:50s;opacity:0.30; animation-direction:reverse;}
@keyframes steamMove{0%,100%{transform:translate(0,0)}50%{transform:translate(5%,-8%)}}
.intro{
  position:fixed;top:0;left:0;width:100%;height:100%;background:var(--bg);
  z-index:20;display:flex;align-items:center;justify-content:center;
  animation:introOut .9s ease forwards;animation-delay:2.2s;
}
.intro-title{
  font-size:48px;font-weight:900;
  background:linear-gradient(120deg,var(--text),var(--brand),var(--text));
  background-size:200% auto;
  -webkit-background-clip:text;
  -webkit-text-fill-color:transparent;
  animation:introIn 1.1s cubic-bezier(.2,.8,.2,1),shimmer 4s infinite;
}
@keyframes introIn{from{opacity:0;transform:scale(.85);filter:blur(6px)}to{opacity:1;transform:scale(1);filter:blur(0)}}
@keyframes introOut{to{opacity:0;visibility:hidden}}
@keyframes shimmer{0%{background-position:0%}100%{background-position:200%}}
@keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-3px)}}
.header{padding:22px 16px 12px;text-align:center;position:relative;z-index:2}
.label-main{font-size:36px;font-weight:900;background:linear-gradient(120deg,var(--text),var(--brand),var(--text));background-size:200% auto;-webkit-background-clip:text;-webkit-text-fill-color:transparent;animation:shimmer 4s infinite,float 3.5s ease-in-out infinite;line-height:1}
.label-sub{font-size:24px;font-weight:700;background:linear-gradient(120deg,var(--text),var(--brand),var(--text));background-size:200% auto;-webkit-background-clip:text;-webkit-text-fill-color:transparent;animation:shimmer 5s infinite;opacity:.85;margin-top:-6px}
.toggle{position:absolute;right:16px;top:22px}
.toggle input{display:none}
.switch{width:46px;height:26px;background:var(--glass);border-radius:999px;position:relative}
.switch::after{content:"";width:22px;height:22px;background:#fff;border-radius:50%;position:absolute;top:2px;left:2px;transition:transform .35s cubic-bezier(.2,.8,.2,1)}
input:checked + .switch::after{transform:translateX(20px)}
.catalog{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:14px;padding:16px;justify-content:center;position:relative;z-index:2}
.card{background:var(--card);backdrop-filter:blur(20px);border-radius:18px;padding:12px;display:flex;flex-direction:column;align-items:center;transition:transform .18s cubic-bezier(.2,.8,.2,1),box-shadow .25s ease}
.card:active{transform:scale(.96)}
.card img{width:100%;height:auto;max-height:120px;border-radius:14px;object-fit:cover}
.card h3{margin-top:8px;font-size:15px;text-align:center}
.card p{font-size:13px;opacity:.75;text-align:center}

.card .price{margin-top:4px;font-weight:700;color:var(--brand);font-size:15px;text-align:center;}
.popup{position:fixed;inset:0;background:rgba(0,0,0,.35);backdrop-filter:blur(6px);display:flex;align-items:flex-end;justify-content:center;opacity:0;pointer-events:none;transition:opacity .3s ease;z-index:10}
.popup.active{opacity:1;pointer-events:auto}
.popup-card{width:100%;max-width:420px;background:var(--card);backdrop-filter:blur(30px);border-radius:26px 26px 0 0;padding:18px;transform:translateY(100%);animation:popupIn .45s cubic-bezier(.2,.8,.2,1) forwards;position:relative}
@keyframes popupIn{to{transform:translateY(0)}}
.popup-card img{width:100%;height:180px;border-radius:18px;object-fit:cover}
.popup-card h2{margin:12px 0 6px;font-size:18px}
.popup-card .price{margin:6px 0;font-size:18px;font-weight:700;color:var(--brand);}
.popup-card p{opacity:.8;margin-bottom:12px;font-size:14px}
input,textarea{width:100%;padding:10px;margin-bottom:12px;border-radius:10px;border:1px solid #ccc;font-size:14px;outline:none;box-sizing:border-box}
body.dark input,body.dark textarea{border:1px solid #555;background:#222;color:#fff}
.btn{width:100%;padding:14px;background:var(--brand);color:#fff;font-size:16px;font-weight:700;border:none;border-radius:14px;transition:transform .15s ease}
.btn:active{transform:scale(.97)}
.close-btn {position: absolute;top: 16px;right: 16px;background: none;border: none;font-size: 28px;color: var(--text);opacity: 0.7;cursor: pointer;}
.close-btn:active {opacity: 1;}
.orders-section {padding: 16px;}
.orders-section h2 {text-align: center; font-size: 24px; margin-bottom: 12px;}
.status-new {color: orange;}
.status-confirmed {color: green;}
.status-cancelled {color: red;}
</style>
</head>
<body>

<div class="intro">
  <div class="intro-title">Барахолка Березники</div>
</div>
<div class="steam"></div>
<div class="header">
  <div class="label-main">Барахолка</div>
  <div class="label-sub">Березники</div>
  <label class="toggle">
    <input type="checkbox" id="themeToggle">
    <div class="switch"></div>
  </label>
</div>

<div class="catalog" id="catalog"></div>

<div class="orders-section">
  <h2>Мои заказы</h2>
  <div class="catalog" id="ordersCatalog"></div>
</div>

<div class="popup" id="popup">
  <div class="popup-card" id="popupCard"></div>
</div>

<script>
const tg = window.Telegram.WebApp;
tg.expand();
tg.disableVerticalSwipes();

const toggle = document.getElementById("themeToggle");
if (localStorage.getItem("theme") === "dark") { document.body.classList.add("dark"); toggle.checked = true; }
toggle.onchange = () => {
  document.body.classList.toggle("dark");
  localStorage.setItem("theme", document.body.classList.contains("dark") ? "dark" : "light");
  tg.HapticFeedback.selectionChanged();
}

const BACKEND_URL = 'https://vaip-vy8j.onrender.com'; // Измени на реальный URL после деплоя
const userId = tg.initDataUnsafe.user?.id;

async function loadProducts() {
  try {
    const response = await fetch(`${BACKEND_URL}/products`);
    const products = await response.json();
    const catalog = document.getElementById("catalog");
    catalog.innerHTML = '';
    products.forEach(p => {
      const card = document.createElement("div");
      card.className = "card";
      card.innerHTML = `
        <img src="${p.image}" alt="${p.title}">
        <h3>${p.title}</h3>
        <p>${p.desc}</p>
        <div class="price">${p.price} ₽</div>
      `;
      card.onclick = () => openPopup(p);
      catalog.appendChild(card);
    });
  } catch (e) {
    tg.showAlert('Ошибка загрузки товаров');
  }
}

async function loadOrders() {
  try {
    const response = await fetch(`${BACKEND_URL}/orders?user_id=${userId}`);
    const orders = await response.json();
    const ordersCatalog = document.getElementById("ordersCatalog");
    ordersCatalog.innerHTML = '';
    if (orders.length === 0) {
      ordersCatalog.innerHTML = '<p style="text-align:center;opacity:0.7;">Нет заказов</p>';
      return;
    }
    orders.forEach(order => {
      const card = document.createElement("div");
      card.className = "card";
      card.innerHTML = `
        <h3>${order.product_name}</h3>
        <div class="price">${order.price} ₽</div>
        <p>Место: ${order.meet_place}</p>
        <p>Время: ${order.meet_time}</p>
        <p>Статус: <span class="status-${order.status}">${order.status === 'new' ? 'Новый' : order.status === 'confirmed' ? 'Подтверждён' : 'Отменён'}</span></p>
      `;
      ordersCatalog.appendChild(card);
    });
  } catch (e) {
    tg.showAlert('Ошибка загрузки заказов');
  }
}

function openPopup(p) {
  const popup = document.getElementById("popup");
  const popupCard = document.getElementById("popupCard");
  popupCard.innerHTML = `
    <button class="close-btn" onclick="document.getElementById('popup').classList.remove('active')">×</button>
    <img src="${p.image}" alt="${p.title}">
    <h2>${p.title}</h2>
    <div class="price">${p.price} ₽</div>
    <p>${p.desc}</p>
    <input type="text" id="meetPlace" placeholder="Место встречи" required>
    <input type="time" id="meetTime" required>
    <button class="btn" id="reserveBtn">Забронировать за ${p.price} ₽</button>
  `;
  document.getElementById("reserveBtn").onclick = () => reserve(p);
  popup.classList.add("active");
}

popup.onclick = e => { if (e.target === popup) popup.classList.remove("active"); }

async function reserve(p) {
  const btn = document.getElementById("reserveBtn");
  if (btn.disabled) return;
  btn.disabled = true;
  btn.textContent = "Отправка...";

  const place = document.getElementById("meetPlace").value.trim();
  const time = document.getElementById("meetTime").value;

  if (!place || !time) {
    tg.showAlert("Укажи место и время встречи!");
    btn.disabled = false;
    btn.textContent = `Забронировать за ${p.price} ₽`;
    return;
  }

  // Валидация времени (+30 мин)
  const now = new Date();
  const minTime = new Date(now.getTime() + 30 * 60 * 1000);
  const [hours, minutes] = time.split(':').map(Number);
  const selectedTime = new Date(now);
  selectedTime.setHours(hours, minutes, 0, 0);

  if (selectedTime < minTime) {
    tg.showAlert("Встречу можно назначить не раньше, чем через 30 минут");
    btn.disabled = false;
    btn.textContent = `Забронировать за ${p.price} ₽`;
    return;
  }

  try {
    const response = await fetch(`${BACKEND_URL}/orders`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        product_name: p.title,
        price: p.price,
        meet_place: place,
        meet_time: time,
        user_id: userId
      })
    });
    if (!response.ok) throw new Error('Failed');
    tg.HapticFeedback.impactOccurred("medium");
    tg.showPopup({ title: "Готово!", message: "Бронь отправлена продавцу.\nОжидай ответа.", buttons: [{type:"ok"}] });
    document.getElementById("popup").classList.remove("active");
    loadOrders(); // Обновить мои заказы
  } catch (e) {
    tg.showAlert('Ошибка отправки');
  } finally {
    btn.disabled = false;
    btn.textContent = `Забронировать за ${p.price} ₽`;
  }
}

loadProducts();
loadOrders();
</script>
</body>
</html>
